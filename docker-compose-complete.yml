version: '3.8'

# ============================================================
# Sistema de Gerenciamento Hospitalar - COMPLETO
# Docker Compose com TODOS os serviços e infraestrutura
# ============================================================
#
# Este arquivo sobe TODO o sistema com um único comando:
#   docker-compose -f docker-compose-complete.yml up -d --build
#
# Serviços incluídos:
#   - 4 Bancos MySQL (agendamento, clínica, centro-cirúrgico, keycloak)
#   - RabbitMQ (mensageria)
#   - Keycloak (autenticação)
#   - Agendamento Service (porta 8081)
#   - Clínica Service (porta 8082)
#   - Centro Cirúrgico Service (porta 8083)
#   - Gateway Service (porta 8080)
# ============================================================

services:
  # ============================================
  # BANCOS DE DADOS MYSQL
  # ============================================

  mysql-agendamento:
    image: mysql:8.0
    container_name: mysql-agendamento
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: agendamento_db
      MYSQL_CHARACTER_SET_SERVER: utf8mb4
      MYSQL_COLLATION_SERVER: utf8mb4_unicode_ci
    ports:
      - "3307:3306"
    volumes:
      - mysql-agendamento-data:/var/lib/mysql
    networks:
      - hospital-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  mysql-clinica:
    image: mysql:8.0
    container_name: mysql-clinica
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: clinica_db
      MYSQL_CHARACTER_SET_SERVER: utf8mb4
      MYSQL_COLLATION_SERVER: utf8mb4_unicode_ci
    ports:
      - "3308:3306"
    volumes:
      - mysql-clinica-data:/var/lib/mysql
    networks:
      - hospital-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  mysql-centro-cirurgico:
    image: mysql:8.0
    container_name: mysql-centro-cirurgico
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: centro_cirurgico_db
      MYSQL_CHARACTER_SET_SERVER: utf8mb4
      MYSQL_COLLATION_SERVER: utf8mb4_unicode_ci
    ports:
      - "3309:3306"
    volumes:
      - mysql-centro-cirurgico-data:/var/lib/mysql
    networks:
      - hospital-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  mysql-keycloak:
    image: mysql:8.0
    container_name: mysql-keycloak
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: keycloak
      MYSQL_CHARACTER_SET_SERVER: utf8mb4
      MYSQL_COLLATION_SERVER: utf8mb4_unicode_ci
    ports:
      - "3310:3306"
    volumes:
      - mysql-keycloak-data:/var/lib/mysql
    networks:
      - hospital-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  # ============================================
  # RABBITMQ (MENSAGERIA)
  # ============================================

  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
      RABBITMQ_DEFAULT_VHOST: /
    ports:
      - "5672:5672"   # AMQP
      - "15672:15672" # Management UI
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    networks:
      - hospital-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    restart: unless-stopped

  # ============================================
  # KEYCLOAK (AUTENTICAÇÃO)
  # ============================================

  keycloak:
    image: quay.io/keycloak/keycloak:23.0
    container_name: keycloak
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_DB: mysql
      KC_DB_URL: jdbc:mysql://mysql-keycloak:3306/keycloak
      KC_DB_USERNAME: root
      KC_DB_PASSWORD: root
      KC_HOSTNAME: localhost
      KC_HTTP_PORT: 8090
      KC_HEALTH_ENABLED: 'true'
      KC_METRICS_ENABLED: 'true'
    ports:
      - "8090:8090"
    command:
      - start-dev
      - --http-port=8090
    depends_on:
      mysql-keycloak:
        condition: service_healthy
    networks:
      - hospital-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8090/health/ready"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  # ============================================
  # MICROSSERVIÇOS
  # ============================================

  agendamento-service:
    build:
      context: ./agendamento-service
      dockerfile: Dockerfile
    container_name: agendamento-service
    environment:
      # Banco de Dados
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql-agendamento:3306/agendamento_db?createDatabaseIfNotExist=true&useSSL=false&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: root

      # RabbitMQ
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: guest
      SPRING_RABBITMQ_PASSWORD: guest

      # Keycloak
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI: http://keycloak:8090/realms/hospital

      # URLs dos outros serviços
      SERVICE_CLINICA_URL: http://clinica-service:8082
      SERVICE_CENTRO_CIRURGICO_URL: http://centro-cirurgico-service:8083

      # JVM Options
      JAVA_OPTS: -Xms512m -Xmx1024m
    ports:
      - "8081:8081"
    depends_on:
      mysql-agendamento:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      keycloak:
        condition: service_healthy
    networks:
      - hospital-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8081/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  clinica-service:
    build:
      context: ./clinica-service
      dockerfile: Dockerfile
    container_name: clinica-service
    environment:
      # Banco de Dados
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql-clinica:3306/clinica_db?createDatabaseIfNotExist=true&useSSL=false&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: root

      # RabbitMQ
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: guest
      SPRING_RABBITMQ_PASSWORD: guest

      # Keycloak
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI: http://keycloak:8090/realms/hospital

      # URLs dos outros serviços
      SERVICE_CENTRO_CIRURGICO_URL: http://centro-cirurgico-service:8083

      # JVM Options
      JAVA_OPTS: -Xms512m -Xmx1024m
    ports:
      - "8082:8082"
    depends_on:
      mysql-clinica:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      keycloak:
        condition: service_healthy
    networks:
      - hospital-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8082/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  centro-cirurgico-service:
    build:
      context: ./centro-cirurgico-service
      dockerfile: Dockerfile
    container_name: centro-cirurgico-service
    environment:
      # Banco de Dados
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql-centro-cirurgico:3306/centro_cirurgico_db?createDatabaseIfNotExist=true&useSSL=false&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: root

      # RabbitMQ
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: guest
      SPRING_RABBITMQ_PASSWORD: guest

      # Keycloak
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI: http://keycloak:8090/realms/hospital

      # JVM Options
      JAVA_OPTS: -Xms512m -Xmx1024m
    ports:
      - "8083:8083"
    depends_on:
      mysql-centro-cirurgico:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      keycloak:
        condition: service_healthy
    networks:
      - hospital-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8083/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  gateway-service:
    build:
      context: ./gateway-service
      dockerfile: Dockerfile
    container_name: gateway-service
    environment:
      # URLs dos microsserviços
      SERVICE_AGENDAMENTO_URL: http://agendamento-service:8081
      SERVICE_CLINICA_URL: http://clinica-service:8082
      SERVICE_CENTRO_CIRURGICO_URL: http://centro-cirurgico-service:8083

      # Keycloak
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI: http://keycloak:8090/realms/hospital

      # JVM Options
      JAVA_OPTS: -Xms256m -Xmx512m
    ports:
      - "8080:8080"
    depends_on:
      agendamento-service:
        condition: service_healthy
      clinica-service:
        condition: service_healthy
      centro-cirurgico-service:
        condition: service_healthy
      keycloak:
        condition: service_healthy
    networks:
      - hospital-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

# ============================================
# REDES
# ============================================

networks:
  hospital-network:
    driver: bridge
    name: hospital-network

# ============================================
# VOLUMES PERSISTENTES
# ============================================

volumes:
  mysql-agendamento-data:
    name: hospital_mysql_agendamento
  mysql-clinica-data:
    name: hospital_mysql_clinica
  mysql-centro-cirurgico-data:
    name: hospital_mysql_centro_cirurgico
  mysql-keycloak-data:
    name: hospital_mysql_keycloak
  rabbitmq-data:
    name: hospital_rabbitmq
